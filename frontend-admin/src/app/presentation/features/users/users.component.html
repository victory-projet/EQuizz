<div class="users-container">
  <!-- Success Message -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <span class="material-icons">check_circle</span>
      {{ successMessage() }}
    </div>
  }

  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h2>Gestion des Administrateurs</h2>
      <p>Gérer les comptes administrateurs du système</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span class="material-icons">add</span>
      Nouvel Administrateur
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher par nom ou email..."
        (input)="onSearch($event)"
        [value]="searchQuery()"
      >
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-container">
    @if (isLoading()) {
      <div class="loading">
        <div class="spinner"></div>
        <p>Chargement...</p>
      </div>
    } @else if (filteredUsers().length === 0) {
      <div class="empty-state">
        <span class="material-icons">people_outline</span>
        <p>Aucun utilisateur trouvé</p>
      </div>
    } @else {
      <table class="users-table">
        <thead>
          <tr>
            <th>Nom Complet</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of paginatedUsers(); track user.id) {
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar">
                    <span class="material-icons">account_circle</span>
                  </div>
                  <div>
                    <div class="user-name">{{ user.prenom }} {{ user.nom }}</div>
                  </div>
                </div>
              </td>
              <td>{{ user.email }}</td>
              <td>
                <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>
                <button 
                  class="status-toggle"
                  [class.active]="user.estActif"
                  (click)="toggleUserStatus(user)">
                  <span class="material-icons">
                    {{ user.estActif ? 'check_circle' : 'cancel' }}
                  </span>
                  {{ user.estActif ? 'Actif' : 'Inactif' }}
                </button>
              </td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="btn-icon" 
                    title="Modifier"
                    (click)="openEditModal(user)">
                    <span class="material-icons">edit</span>
                  </button>
                  <button 
                    class="btn-icon" 
                    title="Réinitialiser mot de passe"
                    (click)="openPasswordModal(user)">
                    <span class="material-icons">lock_reset</span>
                  </button>
                  <button 
                    class="btn-icon btn-danger" 
                    title="Supprimer"
                    (click)="openDeleteModal(user)">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      @if (filteredUsers().length > 0) {
        <div class="pagination-container">
          <div class="pagination-info">
            Affichage {{ (currentPage() - 1) * itemsPerPage() + 1 }} - 
            {{ Math.min(currentPage() * itemsPerPage(), filteredUsers().length) }} 
            sur {{ filteredUsers().length }} utilisateurs
          </div>

          <div class="pagination-controls">
            <select [value]="itemsPerPage()" (change)="changeItemsPerPage(+$any($event.target).value)" class="items-per-page">
              <option [value]="10">10 par page</option>
              <option [value]="25">25 par page</option>
              <option [value]="50">50 par page</option>
              <option [value]="100">100 par page</option>
            </select>

            <div class="pagination-buttons">
              <button 
                class="page-btn" 
                [disabled]="currentPage() === 1"
                (click)="goToPage(currentPage() - 1)">
                <span class="material-icons">chevron_left</span>
              </button>

              @for (page of [].constructor(totalPages()); track $index) {
                @if ($index + 1 === 1 || $index + 1 === totalPages() || 
                     ($index + 1 >= currentPage() - 1 && $index + 1 <= currentPage() + 1)) {
                  <button 
                    class="page-btn" 
                    [class.active]="currentPage() === $index + 1"
                    (click)="goToPage($index + 1)">
                    {{ $index + 1 }}
                  </button>
                } @else if ($index + 1 === currentPage() - 2 || $index + 1 === currentPage() + 2) {
                  <span class="page-ellipsis">...</span>
                }
              }

              <button 
                class="page-btn" 
                [disabled]="currentPage() === totalPages()"
                (click)="goToPage(currentPage() + 1)">
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>
        </div>
      }
    }
  </div>

  <!-- Create/Edit Modal -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ selectedUser() ? 'Modifier' : 'Créer' }} un Administrateur</h3>
          <button class="close-btn" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <form (ngSubmit)="onSubmit()">
          <div class="modal-body">
            @if (errorMessage()) {
              <div class="alert alert-error">
                {{ errorMessage() }}
              </div>
            }

            <div class="form-row">
              <div class="form-group">
                <label>Prénom *</label>
                <input 
                  type="text" 
                  [(ngModel)]="formData.prenom" 
                  name="prenom"
                  required
                >
              </div>

              <div class="form-group">
                <label>Nom *</label>
                <input 
                  type="text" 
                  [(ngModel)]="formData.nom" 
                  name="nom"
                  required
                >
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input 
                type="email" 
                [(ngModel)]="formData.email" 
                name="email"
                [disabled]="!!selectedUser()"
                required
              >
              <small>Format: prenom.nom&#64;saintjeaningenieur.org</small>
            </div>

            @if (!selectedUser()) {
              <div class="form-group">
                <label>Mot de passe *</label>
                <div class="password-input-group">
                  <input 
                    type="text" 
                    [(ngModel)]="formData.motDePasse" 
                    name="motDePasse"
                    required
                    placeholder="Entrez un mot de passe ou générez-en un"
                  >
                  <button 
                    type="button" 
                    class="btn-generate-password" 
                    (click)="onGeneratePassword()"
                    title="Générer un mot de passe">
                    <span class="material-icons">autorenew</span>
                  </button>
                </div>
                <small>Un email sera envoyé avec les identifiants de connexion.</small>
              </div>
            }
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading()">
              {{ selectedUser() ? 'Mettre à jour' : 'Créer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Delete Modal -->
  @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content modal-small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirmer la suppression</h3>
          <button class="close-btn" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer l'utilisateur <strong>{{ selectedUser()?.prenom }} {{ selectedUser()?.nom }}</strong> ?</p>
          <p class="warning-text">Cette action est irréversible.</p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">
            Annuler
          </button>
          <button class="btn btn-danger" (click)="deleteUser()" [disabled]="isLoading()">
            Supprimer
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Password Reset Modal -->
  @if (showPasswordModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content modal-small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Réinitialiser le mot de passe</h3>
          <button class="close-btn" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <form (ngSubmit)="resetPassword()">
          <div class="modal-body">
            @if (errorMessage()) {
              <div class="alert alert-error">
                {{ errorMessage() }}
              </div>
            }

            <p>Utilisateur: <strong>{{ selectedUser()?.prenom }} {{ selectedUser()?.nom }}</strong></p>

            <div class="form-group">
              <label>Nouveau mot de passe *</label>
              <input 
                type="password" 
                [(ngModel)]="passwordData.nouveauMotDePasse" 
                name="nouveauMotDePasse"
                required
              >
            </div>

            <div class="form-group">
              <label>Confirmer le mot de passe *</label>
              <input 
                type="password" 
                [(ngModel)]="passwordData.confirmMotDePasse" 
                name="confirmMotDePasse"
                required
              >
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading()">
              Réinitialiser
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
