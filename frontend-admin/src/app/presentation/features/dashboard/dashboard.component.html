<div class="dashboard-container">
  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Chargement du tableau de bord...</p>
    </div>
  }

  @if (errorMessage()) {
    <div class="error-state">
      <span class="material-icons">error</span>
      <h3>{{ errorMessage() }}</h3>
      <button class="btn-primary" (click)="loadDashboard()">Réessayer</button>
    </div>
  }

  @if (!isLoading() && !errorMessage() && dashboardData()) {


    <!-- Cards de statistiques -->
    <div class="stats-grid">
      <!-- Étudiants actifs -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Étudiants actifs</span>
          <div class="stat-icon purple">
            <span class="material-icons">school</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.totalEtudiants }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.etudiants > 0" [class.negative]="dashboardData()!.trends.etudiants < 0">
            {{ dashboardData()!.trends.etudiants > 0 ? '+' : '' }}{{ dashboardData()!.trends.etudiants }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>

      <!-- Cours (UE) -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Cours (UE)</span>
          <div class="stat-icon green">
            <span class="material-icons">menu_book</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.totalCours }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.cours > 0" [class.negative]="dashboardData()!.trends.cours < 0">
            {{ dashboardData()!.trends.cours > 0 ? '+' : '' }}{{ dashboardData()!.trends.cours }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>

      <!-- Quizz publiés -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Quizz publiés</span>
          <div class="stat-icon blue">
            <span class="material-icons">quiz</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.evaluationsActives }}</div>
        <div class="stat-trend" [class.positive]="dashboardData()!.trends.evaluations > 0" [class.negative]="dashboardData()!.trends.evaluations < 0">
          {{ dashboardData()!.trends.evaluations > 0 ? '+' : '' }}{{ dashboardData()!.trends.evaluations }}% ce mois
        </div>
      </div>

      <!-- Évaluations en cours -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Évaluations en cours</span>
          <div class="stat-icon blue">
            <span class="material-icons">pending_actions</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.evaluationsActives }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.evaluations > 0" [class.negative]="dashboardData()!.trends.evaluations < 0">
            {{ dashboardData()!.trends.evaluations > 0 ? '+' : '' }}{{ dashboardData()!.trends.evaluations }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-grid">
      <!-- Graphique circulaire - Répartition des évaluations -->
      <div class="chart-card pie-chart-card">
        <div class="chart-header">
          <h3>Répartition des évaluations</h3>
          <div class="filter-dropdown">
            <button class="filter-btn" (click)="toggleYearDropdown()">
              {{ getYearLabel() }}
              <span class="material-icons">arrow_drop_down</span>
            </button>
            @if (showYearDropdown()) {
              <div class="dropdown-menu">
                @for (year of years; track year) {
                  <div class="dropdown-item" 
                       [class.active]="selectedYear() === year"
                       (click)="selectYear(year)">
                    {{ year }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <canvas baseChart
                    [data]="pieChartData()"
                    [type]="pieChartType"
                    [options]="pieChartOptions">
            </canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <span class="legend-dot teal"></span>
              <span class="legend-label">Completed</span>
              <span class="legend-value">{{ getPercentage('completed') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot purple"></span>
              <span class="legend-label">On Hold</span>
              <span class="legend-value">{{ getPercentage('onhold') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot blue"></span>
              <span class="legend-label">On Progress</span>
              <span class="legend-value">{{ getPercentage('progress') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot red"></span>
              <span class="legend-label">Pending</span>
              <span class="legend-value">{{ getPercentage('pending') }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Graphique linéaire - Taux de participation -->
      <div class="chart-card line-chart-card">
        <div class="chart-header">
          <h3>Taux de participation</h3>
          <div class="filter-dropdown">
            <button class="filter-btn" (click)="toggleSemesterDropdown()">
              {{ getSemesterLabel() }}
              <span class="material-icons">arrow_drop_down</span>
            </button>
            @if (showSemesterDropdown()) {
              <div class="dropdown-menu">
                @for (semester of semesters; track semester.value) {
                  <div class="dropdown-item" 
                       [class.active]="selectedSemester() === semester.value"
                       (click)="selectSemester(semester.value)">
                    {{ semester.label }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-wrapper full-width">
            <canvas baseChart
                    [data]="lineChartData()"
                    [type]="lineChartType"
                    [options]="lineChartOptions">
            </canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Section inférieure : Alertes & Activités -->
    <div class="bottom-section">
      <!-- Alertes & Suivi -->
      <div class="alerts-section">
        <h3>Alertes & Suivi</h3>
        <div class="alerts-list">
          @if (dashboardData()!.alerts && dashboardData()!.alerts.length > 0) {
            @for (alert of dashboardData()!.alerts; track $index) {
              <div class="alert-item" [class.warning]="alert.type === 'warning'">
                <div class="alert-content">
                  <h4>{{ alert.title }}</h4>
                  <p>{{ alert.message }}</p>
                </div>
                <button class="alert-action">
                  <span class="material-icons">add</span>
                </button>
              </div>
            }
          } @else {
            <div class="empty-state">
              <span class="material-icons">notifications_none</span>
              <p>Aucune alerte pour le moment</p>
            </div>
          }
        </div>
      </div>

      <!-- Activités récentes -->
      <div class="activities-section">
        <div class="activities-header">
          <h3>Activités récentes</h3>
          <a href="#" class="view-more">Voir plus</a>
        </div>
        <div class="activities-list">
          @for (evaluation of dashboardData()!.evaluationsRecentes.slice(0, 2); track evaluation.id) {
            <div class="activity-item" [class.highlighted]="$index === 1">
              <div class="activity-icon">
                <span class="material-icons">wb_sunny</span>
              </div>
              <div class="activity-content">
                <h4>Nouveau quizz publié</h4>
                <p>{{ evaluation.titre }} – {{ evaluation.cours }}</p>
                <span class="activity-time">Il y a 2 heures</span>
              </div>
            </div>
          }
          @if (dashboardData()!.evaluationsRecentes.length === 0) {
            <div class="empty-state">
              <span class="material-icons">inbox</span>
              <p>Aucune activité récente</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
