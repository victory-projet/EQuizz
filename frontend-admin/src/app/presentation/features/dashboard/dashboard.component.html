<div class="dashboard-container">
  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Chargement du tableau de bord...</p>
    </div>
  }

  @if (errorMessage()) {
    <div class="error-state">
      <span class="material-icons">error</span>
      <h3>{{ errorMessage() }}</h3>
      <button class="btn-primary" (click)="loadDashboard()">Réessayer</button>
    </div>
  }

  @if (!isLoading() && !errorMessage() && dashboardData()) {


    <!-- Cards de statistiques -->
    <div class="stats-grid">
      <!-- Étudiants actifs -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Étudiants actifs</span>
          <div class="stat-icon purple">
            <span class="material-icons">school</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.totalEtudiants }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.etudiants > 0" [class.negative]="dashboardData()!.trends.etudiants < 0">
            {{ dashboardData()!.trends.etudiants > 0 ? '+' : '' }}{{ dashboardData()!.trends.etudiants }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>

      <!-- Cours (UE) -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Cours (UE)</span>
          <div class="stat-icon green">
            <span class="material-icons">menu_book</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.totalCours }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.cours > 0" [class.negative]="dashboardData()!.trends.cours < 0">
            {{ dashboardData()!.trends.cours > 0 ? '+' : '' }}{{ dashboardData()!.trends.cours }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>

      <!-- Quizz publiés -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Quizz publiés</span>
          <div class="stat-icon blue">
            <span class="material-icons">quiz</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.evaluationsActives }}</div>
        <div class="stat-trend" [class.positive]="dashboardData()!.trends.evaluations > 0" [class.negative]="dashboardData()!.trends.evaluations < 0">
          {{ dashboardData()!.trends.evaluations > 0 ? '+' : '' }}{{ dashboardData()!.trends.evaluations }}% ce mois
        </div>
      </div>

      <!-- Évaluations en cours -->
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-label">Évaluations en cours</span>
          <div class="stat-icon blue">
            <span class="material-icons">pending_actions</span>
          </div>
        </div>
        <div class="stat-value">{{ dashboardData()!.overview.evaluationsActives }}</div>
        @if (dashboardData()!.trends) {
          <div class="stat-trend" [class.positive]="dashboardData()!.trends.evaluations > 0" [class.negative]="dashboardData()!.trends.evaluations < 0">
            {{ dashboardData()!.trends.evaluations > 0 ? '+' : '' }}{{ dashboardData()!.trends.evaluations }}% ce mois
          </div>
        } @else {
          <div class="stat-trend positive">Chargement...</div>
        }
      </div>
    </div>

    <!-- Graphiques -->
    <div class="charts-grid">
      <!-- Graphique circulaire - Répartition des évaluations -->
      <div class="chart-card pie-chart-card">
        <div class="chart-header">
          <h3>Répartition des évaluations</h3>
          <div class="filter-dropdown">
            <button class="filter-btn" (click)="toggleYearDropdown()">
              {{ getYearLabel() }}
              <span class="material-icons">arrow_drop_down</span>
            </button>
            @if (showYearDropdown()) {
              <div class="dropdown-menu">
                @for (year of years; track year) {
                  <div class="dropdown-item" 
                       [class.active]="selectedYear() === year"
                       (click)="selectYear(year)">
                    {{ year }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <canvas baseChart
                    [data]="pieChartData()"
                    [type]="pieChartType"
                    [options]="pieChartOptions">
            </canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <span class="legend-dot teal"></span>
              <span class="legend-label">Completed</span>
              <span class="legend-value">{{ getPercentage('completed') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot purple"></span>
              <span class="legend-label">On Hold</span>
              <span class="legend-value">{{ getPercentage('onhold') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot blue"></span>
              <span class="legend-label">On Progress</span>
              <span class="legend-value">{{ getPercentage('progress') }}%</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot red"></span>
              <span class="legend-label">Pending</span>
              <span class="legend-value">{{ getPercentage('pending') }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Graphique linéaire - Taux de participation -->
      <div class="chart-card line-chart-card">
        <div class="chart-header">
          <h3>Taux de participation</h3>
          <div class="filter-dropdown">
            <button class="filter-btn" (click)="toggleSemesterDropdown()">
              {{ getSemesterLabel() }}
              <span class="material-icons">arrow_drop_down</span>
            </button>
            @if (showSemesterDropdown()) {
              <div class="dropdown-menu">
                @for (semester of semesters; track semester.value) {
                  <div class="dropdown-item" 
                       [class.active]="selectedSemester() === semester.value"
                       (click)="selectSemester(semester.value)">
                    {{ semester.label }}
                  </div>
                }
              </div>
            }
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-wrapper full-width">
            <canvas baseChart
                    [data]="lineChartData()"
                    [type]="lineChartType"
                    [options]="lineChartOptions">
            </canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Section inférieure : Alertes & Activités -->
    <div class="bottom-section">
      <!-- Alertes & Notifications -->
      <div class="alerts-section">
        <div class="section-header">
          <div class="header-left">
            <h3>Alertes & Notifications</h3>
            @if (unreadAlertsCount() > 0) {
              <span class="unread-badge">{{ unreadAlertsCount() }}</span>
            }
          </div>
          <div class="header-actions">
            @if (dashboardData()!.alerts && dashboardData()!.alerts.length > 0) {
              <button class="btn-text" (click)="markAllAlertsAsRead()" 
                      [disabled]="unreadAlertsCount() === 0">
                <span class="material-icons">done_all</span>
                Tout marquer comme lu
              </button>
            }
            @if (dashboardData()!.alerts && dashboardData()!.alerts.length > 3) {
              <button class="btn-text" (click)="toggleShowAllAlerts()">
                {{ showAllAlerts() ? 'Voir moins' : 'Voir tout' }}
                <span class="material-icons">
                  {{ showAllAlerts() ? 'expand_less' : 'expand_more' }}
                </span>
              </button>
            }
          </div>
        </div>

        <div class="alerts-list">
          @if (getDisplayedAlerts().length > 0) {
            @for (alert of getDisplayedAlerts(); track alert.id) {
              <div class="alert-item" 
                   [class]="getAlertClass(alert.type) + ' ' + getPriorityClass(alert.priority)"
                   [class.unread]="!alert.isRead">
                <div class="alert-icon">
                  <span class="material-icons">{{ getAlertIcon(alert.type) }}</span>
                </div>
                <div class="alert-content" (click)="markAlertAsRead(alert.id)">
                  <div class="alert-header">
                    <h4>{{ alert.title }}</h4>
                    <span class="alert-time">{{ getTimeAgo(alert.date) }}</span>
                  </div>
                  <p>{{ alert.message }}</p>
                  @if (alert.actionUrl && alert.actionLabel) {
                    <a [href]="alert.actionUrl" class="alert-action-link">
                      {{ alert.actionLabel }}
                      <span class="material-icons">arrow_forward</span>
                    </a>
                  }
                </div>
                <div class="alert-actions">
                  @if (!alert.isRead) {
                    <button class="btn-icon" (click)="markAlertAsRead(alert.id)" title="Marquer comme lu">
                      <span class="material-icons">check</span>
                    </button>
                  }
                  <button class="btn-icon" (click)="dismissAlert(alert.id)" title="Supprimer">
                    <span class="material-icons">close</span>
                  </button>
                </div>
              </div>
            }
          } @else {
            <div class="empty-state">
              <span class="material-icons">notifications_none</span>
              <p>Aucune alerte pour le moment</p>
              <small>Les notifications importantes apparaîtront ici</small>
            </div>
          }
        </div>
      </div>

      <!-- Activités récentes -->
      <div class="activities-section">
        <div class="section-header">
          <div class="header-left">
            <h3>Activités récentes</h3>
          </div>
          <div class="header-actions">
            @if (dashboardData()!.activitesRecentes && dashboardData()!.activitesRecentes.length > 4) {
              <button class="btn-text" (click)="toggleShowAllActivities()">
                {{ showAllActivities() ? 'Voir moins' : 'Voir tout' }}
                <span class="material-icons">
                  {{ showAllActivities() ? 'expand_less' : 'expand_more' }}
                </span>
              </button>
            }
            <a href="/notifications" class="btn-text">
              Voir toutes les activités
              <span class="material-icons">arrow_forward</span>
            </a>
          </div>
        </div>

        <div class="activities-list">
          @if (getDisplayedActivities().length > 0) {
            @for (activity of getDisplayedActivities(); track activity.id) {
              <div class="activity-item">
                <div class="activity-icon" [style.background-color]="activity.color">
                  <span class="material-icons">{{ getActivityIcon(activity.type) }}</span>
                </div>
                <div class="activity-content">
                  <div class="activity-header">
                    <h4>{{ activity.title }}</h4>
                    <span class="activity-time">{{ getTimeAgo(activity.date) }}</span>
                  </div>
                  <p>{{ activity.description }}</p>
                  <div class="activity-meta">
                    <span class="activity-user">
                      <span class="material-icons">person</span>
                      {{ activity.user }}
                    </span>
                  </div>
                </div>
              </div>
            }
          } @else {
            <div class="empty-state">
              <span class="material-icons">inbox</span>
              <p>Aucune activité récente</p>
              <small>Les dernières actions apparaîtront ici</small>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
