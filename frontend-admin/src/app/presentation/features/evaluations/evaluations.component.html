<div class="page-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Gestion des Quiz</h1>
      <p class="page-subtitle">Vue d'ensemble de tous vos questionnaires d'évaluation</p>
    </div>
    <button class="btn-primary" (click)="createEvaluation()">
      <span class="material-icons">add</span> Créer un Quiz
    </button>
  </div>

  <!-- Messages -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <span class="material-icons">check_circle</span>
      {{ successMessage() }}
      <button class="alert-close" (click)="successMessage.set('')">
        <span class="material-icons">close</span>
      </button>
    </div>
  }
  @if (errorMessage()) {
    <div class="alert alert-error">
      <span class="material-icons">error</span>
      {{ errorMessage() }}
      <button class="alert-close" (click)="errorMessage.set('')">
        <span class="material-icons">close</span>
      </button>
    </div>
  }

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon stat-icon-purple">
        <span class="material-icons">assignment</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalQuiz() }}</div>
        <div class="stat-label">Total Quiz</div>
        <div class="stat-sublabel">+3 ce mois</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-green">
        <span class="material-icons">trending_up</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ activeQuiz() }}</div>
        <div class="stat-label">Quiz actifs</div>
        <div class="stat-sublabel">En cours</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-blue">
        <span class="material-icons">groups</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">76%</div>
        <div class="stat-label">Taux de participation</div>
        <div class="stat-sublabel">+12% vs mois dernier</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon stat-icon-orange">
        <span class="material-icons">edit_note</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ draftQuiz() }}</div>
        <div class="stat-label">Brouillons</div>
        <div class="stat-sublabel">À finaliser</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher un quiz par titre, UE ou classe..."
        (input)="onSearch($event)"
        [value]="searchQuery()"
      />
      @if (searchQuery()) {
        <button class="clear-search" (click)="clearSearch()">
          <span class="material-icons">close</span>
        </button>
      }
    </div>
    
    <div class="filter-buttons">
      <!-- Filtres Dropdown -->
      <div class="dropdown-container">
        <button class="btn-filter" (click)="toggleFilters()" [class.active]="showFilters()">
          <span class="material-icons">filter_list</span> 
          Filtres
          @if (hasActiveFilters()) {
            <span class="filter-count">{{ getActiveFiltersCount() }}</span>
          }
        </button>
        
        @if (showFilters()) {
          <div class="dropdown-menu filters-menu">
            <div class="dropdown-header">
              <h4>Filtrer les évaluations</h4>
              <button class="btn-text" (click)="resetFilters()">Réinitialiser</button>
            </div>
            
            <!-- Filtre par Statut -->
            <div class="filter-group">
              <label class="filter-label">Statut</label>
              <div class="filter-options">
                <label class="checkbox-option">
                  <input type="radio" name="status" value="ALL" 
                         [checked]="filterStatus() === 'ALL'"
                         (change)="onFilterStatus('ALL')">
                  <span>Tous les statuts</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="status" value="BROUILLON"
                         [checked]="filterStatus() === 'BROUILLON'"
                         (change)="onFilterStatus('BROUILLON')">
                  <span>Brouillons ({{ draftQuiz() }})</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="status" value="PUBLIEE"
                         [checked]="filterStatus() === 'PUBLIEE'"
                         (change)="onFilterStatus('PUBLIEE')">
                  <span>En cours ({{ activeQuiz() }})</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="status" value="CLOTUREE"
                         [checked]="filterStatus() === 'CLOTUREE'"
                         (change)="onFilterStatus('CLOTUREE')">
                  <span>Clôturées ({{ closedQuiz() }})</span>
                </label>
              </div>
            </div>

            <!-- Filtre par Période -->
            <div class="filter-group">
              <label class="filter-label">Période de création</label>
              <div class="filter-options">
                <label class="checkbox-option">
                  <input type="radio" name="period" value="ALL"
                         [checked]="filterPeriod() === 'ALL'"
                         (change)="onFilterPeriod('ALL')">
                  <span>Toutes les périodes</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="period" value="TODAY"
                         [checked]="filterPeriod() === 'TODAY'"
                         (change)="onFilterPeriod('TODAY')">
                  <span>Aujourd'hui</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="period" value="WEEK"
                         [checked]="filterPeriod() === 'WEEK'"
                         (change)="onFilterPeriod('WEEK')">
                  <span>Cette semaine</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="period" value="MONTH"
                         [checked]="filterPeriod() === 'MONTH'"
                         (change)="onFilterPeriod('MONTH')">
                  <span>Ce mois</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="period" value="SEMESTER"
                         [checked]="filterPeriod() === 'SEMESTER'"
                         (change)="onFilterPeriod('SEMESTER')">
                  <span>Ce semestre</span>
                </label>
              </div>
            </div>

            <!-- Filtre par Nombre de Questions -->
            <div class="filter-group">
              <label class="filter-label">Nombre de questions</label>
              <div class="filter-options">
                <label class="checkbox-option">
                  <input type="radio" name="questions" value="ALL"
                         [checked]="filterQuestions() === 'ALL'"
                         (change)="onFilterQuestions('ALL')">
                  <span>Tous</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="questions" value="EMPTY"
                         [checked]="filterQuestions() === 'EMPTY'"
                         (change)="onFilterQuestions('EMPTY')">
                  <span>Sans questions (0)</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="questions" value="FEW"
                         [checked]="filterQuestions() === 'FEW'"
                         (change)="onFilterQuestions('FEW')">
                  <span>Peu de questions (1-5)</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="questions" value="MEDIUM"
                         [checked]="filterQuestions() === 'MEDIUM'"
                         (change)="onFilterQuestions('MEDIUM')">
                  <span>Questions moyennes (6-15)</span>
                </label>
                <label class="checkbox-option">
                  <input type="radio" name="questions" value="MANY"
                         [checked]="filterQuestions() === 'MANY'"
                         (change)="onFilterQuestions('MANY')">
                  <span>Beaucoup de questions (16+)</span>
                </label>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Tri Dropdown -->
      <div class="dropdown-container">
        <button class="btn-filter" (click)="toggleSortMenu()" [class.active]="showSortMenu()">
          <span class="material-icons">sort</span> 
          Trier par: {{ getSortLabel(sortBy()) }}
          <span class="material-icons sort-direction">
            {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
          </span>
        </button>
        
        @if (showSortMenu()) {
          <div class="dropdown-menu sort-menu">
            <div class="dropdown-header">
              <h4>Trier les évaluations</h4>
            </div>
            
            <div class="sort-options">
              <button class="sort-option" 
                      [class.active]="sortBy() === 'dateCreation'"
                      (click)="onSort('dateCreation')">
                <span class="material-icons">schedule</span>
                <span>Date de création</span>
                @if (sortBy() === 'dateCreation') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'titre'"
                      (click)="onSort('titre')">
                <span class="material-icons">title</span>
                <span>Titre (A-Z)</span>
                @if (sortBy() === 'titre') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'dateDebut'"
                      (click)="onSort('dateDebut')">
                <span class="material-icons">event_available</span>
                <span>Date de début</span>
                @if (sortBy() === 'dateDebut') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'dateFin'"
                      (click)="onSort('dateFin')">
                <span class="material-icons">event_busy</span>
                <span>Date de fin</span>
                @if (sortBy() === 'dateFin') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'statut'"
                      (click)="onSort('statut')">
                <span class="material-icons">flag</span>
                <span>Statut</span>
                @if (sortBy() === 'statut') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'cours'"
                      (click)="onSort('cours')">
                <span class="material-icons">book</span>
                <span>Cours/UE</span>
                @if (sortBy() === 'cours') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
              
              <button class="sort-option"
                      [class.active]="sortBy() === 'questions'"
                      (click)="onSort('questions')">
                <span class="material-icons">help_outline</span>
                <span>Nombre de questions</span>
                @if (sortBy() === 'questions') {
                  <span class="material-icons sort-icon">
                    {{ sortOrder() === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                  </span>
                }
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab" 
      [class.active]="filterStatus() === 'ALL'"
      (click)="onFilterStatus('ALL')"
    >
      Tous ({{ totalQuiz() }})
    </button>
    <button 
      class="tab" 
      [class.active]="filterStatus() === 'PUBLIEE'"
      (click)="onFilterStatus('PUBLIEE')"
    >
      En cours ({{ activeQuiz() }})
    </button>
    <button 
      class="tab" 
      [class.active]="filterStatus() === 'BROUILLON'"
      (click)="onFilterStatus('BROUILLON')"
    >
      Brouillons ({{ draftQuiz() }})
    </button>
    <button 
      class="tab" 
      [class.active]="filterStatus() === 'CLOTUREE'"
      (click)="onFilterStatus('CLOTUREE')"
    >
      Clôturés ({{ closedQuiz() }})
    </button>
  </div>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading">Chargement...</div>
  }

  <!-- Evaluations List -->
  @if (!isLoading()) {
    <div class="evaluations-grid">
      @for (evaluation of filteredEvaluations(); track evaluation.id) {
        <div class="evaluation-card">
          <div class="card-header">
            <span class="badge" [ngClass]="getStatusBadgeClass(evaluation.statut)">
              {{ getStatusLabel(evaluation.statut) }}
            </span>
            <div class="card-actions">
              <button class="btn-icon" [title]="'Actions pour ' + evaluation.titre" (click)="toggleCardMenu(evaluation.id)">
                <span class="material-icons">more_vert</span>
              </button>
              @if (showCardMenu() === evaluation.id) {
                <div class="card-menu">
                  @if (evaluation.statut === 'BROUILLON') {
                    <button class="menu-item" (click)="editEvaluation(evaluation); hideCardMenu()">
                      <span class="material-icons">edit</span> Modifier
                    </button>
                    <button class="menu-item" (click)="duplicateEvaluation(evaluation); hideCardMenu()">
                      <span class="material-icons">content_copy</span> Dupliquer
                    </button>
                    <button class="menu-item danger" (click)="deleteEvaluation(evaluation); hideCardMenu()">
                      <span class="material-icons">delete</span> Supprimer
                    </button>
                  }
                  @if (evaluation.statut === 'PUBLIEE') {
                    <button class="menu-item" (click)="viewSubmissions(evaluation); hideCardMenu()">
                      <span class="material-icons">assignment_turned_in</span> Voir les soumissions
                    </button>
                    <button class="menu-item" (click)="duplicateEvaluation(evaluation); hideCardMenu()">
                      <span class="material-icons">content_copy</span> Dupliquer
                    </button>
                  }
                  @if (evaluation.statut === 'CLOTUREE') {
                    <button class="menu-item" (click)="viewSubmissions(evaluation); hideCardMenu()">
                      <span class="material-icons">assignment_turned_in</span> Voir les soumissions
                    </button>
                    <button class="menu-item" (click)="exportResults(evaluation); hideCardMenu()">
                      <span class="material-icons">download</span> Exporter les résultats
                    </button>
                    <button class="menu-item" (click)="duplicateEvaluation(evaluation); hideCardMenu()">
                      <span class="material-icons">content_copy</span> Dupliquer
                    </button>
                  }
                </div>
              }
            </div>
          </div>

          <div class="card-body" (click)="viewEvaluation(evaluation.id)">
            <h3 class="card-title">{{ evaluation.titre }}</h3>
            <p class="card-description">{{ evaluation.description || 'Aucune description' }}</p>
            
            <div class="card-meta">
              <div class="meta-item">
                <span class="material-icons">book</span>
                <span>{{ getCoursName(evaluation) }}</span>
              </div>
              <div class="meta-item">
                <span class="material-icons">calendar_today</span>
                <span>{{ formatDate(evaluation.dateDebut) }}</span>
              </div>
              <div class="meta-item">
                <span class="material-icons">schedule</span>
                <span>Fin: {{ formatDate(evaluation.dateFin) }}</span>
              </div>
            </div>

            <div class="card-stats">
              <div class="stat-item">
                <span class="material-icons">help_outline</span>
                <span>{{ getQuestionCount(evaluation) }} questions</span>
              </div>
              <div class="stat-item">
                <span class="material-icons">people</span>
                <span>{{ getClassesCount(evaluation) }} classe(s)</span>
              </div>
              @if (evaluation.statut === 'PUBLIEE' || evaluation.statut === 'CLOTUREE') {
                <div class="stat-item">
                  <span class="material-icons">assignment_turned_in</span>
                  <span>{{ getSubmissionsCount(evaluation) }} soumissions</span>
                </div>
              }
            </div>
          </div>

          <div class="card-footer">
            @if (evaluation.statut === 'BROUILLON') {
              <button class="btn-outline" (click)="editEvaluation(evaluation); $event.stopPropagation()">
                <span class="material-icons">edit</span> Modifier
              </button>
              @if (getQuestionCount(evaluation) > 0) {
                <button class="btn-primary" (click)="publishEvaluation(evaluation); $event.stopPropagation()">
                  <span class="material-icons">send</span> Publier
                </button>
              } @else {
                <button class="btn-primary" disabled title="Ajoutez des questions avant de publier">
                  <span class="material-icons">send</span> Publier
                </button>
              }
            }
            @if (evaluation.statut === 'PUBLIEE') {
              <button class="btn-outline" (click)="viewEvaluation(evaluation.id); $event.stopPropagation()">
                <span class="material-icons">visibility</span> Voir
              </button>
              <button class="btn-secondary" (click)="viewSubmissions(evaluation); $event.stopPropagation()">
                <span class="material-icons">assignment_turned_in</span> Soumissions
              </button>
              <button class="btn-primary" (click)="closeEvaluation(evaluation); $event.stopPropagation()">
                <span class="material-icons">lock</span> Fermer
              </button>
            }
            @if (evaluation.statut === 'CLOTUREE') {
              <button class="btn-outline" (click)="viewEvaluation(evaluation.id); $event.stopPropagation()">
                <span class="material-icons">visibility</span> Voir
              </button>
              <button class="btn-secondary" (click)="viewSubmissions(evaluation); $event.stopPropagation()">
                <span class="material-icons">assignment_turned_in</span> Soumissions
              </button>
              <button class="btn-primary" (click)="viewResults(evaluation); $event.stopPropagation()">
                <span class="material-icons">bar_chart</span> Rapport
              </button>
            }
          </div>
        </div>
      }
    </div>

    @if (filteredEvaluations().length === 0) {
      <div class="empty-state">
        <span class="material-icons empty-icon">assignment</span>
        <h3>Aucune évaluation trouvée</h3>
        <p>Commencez par créer votre première évaluation</p>
        <button class="btn-primary" (click)="createEvaluation()">
          <span class="material-icons">add</span> Créer un Quiz
        </button>
      </div>
    }
  }
</div>