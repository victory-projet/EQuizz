<div class="students-container">
  @if (successMessage()) {
    <div class="alert alert-success">
      <span class="material-icons">check_circle</span>
      {{ successMessage() }}
    </div>
  }

  <div class="page-header">
    <div class="header-left">
      <h2>Gestion des Étudiants</h2>
      <p>Gérez les étudiants et leurs classes</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span class="material-icons">add</span>
      Nouvel Étudiant
    </button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">
        <span class="material-icons">school</span>
      </div>
      <div class="stat-content">
        <div class="stat-label">Total Étudiants</div>
        <div class="stat-value">{{ totalStudents() }}</div>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">
        <span class="material-icons">check_circle</span>
      </div>
      <div class="stat-content">
        <div class="stat-label">Actifs</div>
        <div class="stat-value">{{ activeStudents() }}</div>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">
        <span class="material-icons">block</span>
      </div>
      <div class="stat-content">
        <div class="stat-label">Inactifs</div>
        <div class="stat-value">{{ inactiveStudents() }}</div>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="search-box">
      <span class="material-icons">search</span>
      <input 
        type="text" 
        placeholder="Rechercher un étudiant..."
        (input)="onSearch($event)"
        [value]="searchQuery()"
      >
    </div>

    <div class="filter-buttons">
      <button 
        class="filter-btn" 
        [class.active]="filterStatus() === 'ALL'"
        (click)="onFilterStatus('ALL')">
        Tous
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterStatus() === 'ACTIVE'"
        (click)="onFilterStatus('ACTIVE')">
        Actifs
      </button>
      <button 
        class="filter-btn" 
        [class.active]="filterStatus() === 'INACTIVE'"
        (click)="onFilterStatus('INACTIVE')">
        Inactifs
      </button>
    </div>

    <div class="filter-select">
      <select (change)="onFilterClasse($any($event.target).value)" [value]="filterClasse()">
        <option value="ALL">Toutes les classes</option>
        @for (classe of classes(); track classe.id) {
          <option [value]="classe.id">{{ classe.nom }}</option>
        }
      </select>
    </div>
  </div>

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Chargement...</p>
    </div>
  }

  @if (!isLoading()) {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Prénom</th>
            <th>Email</th>
            <th>Matricule</th>
            <th>Classe</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (student of filteredStudents(); track student.id) {
            <tr>
              <td>{{ student.nom }}</td>
              <td>{{ student.prenom }}</td>
              <td>{{ student.email }}</td>
              <td>{{ student.matricule || '-' }}</td>
              <td>
                <span class="badge badge-info">{{ getClasseNom(student.classeId) }}</span>
              </td>
              <td>
                <span class="badge" [class.badge-success]="student.estActif" [class.badge-danger]="!student.estActif">
                  {{ student.estActif ? 'Actif' : 'Inactif' }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button 
                    class="btn-icon" 
                    (click)="openEditModal(student)"
                    title="Modifier">
                    <span class="material-icons">edit</span>
                  </button>
                  <button 
                    class="btn-icon" 
                    (click)="toggleStatus(student)"
                    [title]="student.estActif ? 'Désactiver' : 'Activer'">
                    <span class="material-icons">{{ student.estActif ? 'block' : 'check_circle' }}</span>
                  </button>
                  <button 
                    class="btn-icon btn-danger" 
                    (click)="openDeleteModal(student)"
                    title="Supprimer">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      @if (filteredStudents().length === 0) {
        <div class="empty-state">
          <span class="material-icons">school</span>
          <p>Aucun étudiant trouvé</p>
          @if (searchQuery() || filterClasse() !== 'ALL' || filterStatus() !== 'ALL') {
            <button class="btn btn-secondary" (click)="searchQuery.set(''); filterClasse.set('ALL'); filterStatus.set('ALL'); applyFilters()">
              Réinitialiser les filtres
            </button>
          } @else {
            <button class="btn btn-primary" (click)="openCreateModal()">
              Créer le premier étudiant
            </button>
          }
        </div>
      }
    </div>
  }

  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ selectedStudent() ? 'Modifier' : 'Créer' }} un Étudiant</h3>
          <button class="close-btn" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <form (ngSubmit)="onSubmit()">
          <div class="modal-body">
            @if (errorMessage()) {
              <div class="alert alert-error">
                {{ errorMessage() }}
              </div>
            }

            <div class="form-row">
              <div class="form-group">
                <label>Nom *</label>
                <input 
                  type="text" 
                  [(ngModel)]="formData.nom" 
                  name="nom"
                  placeholder="Nom de famille"
                  required
                >
              </div>

              <div class="form-group">
                <label>Prénom *</label>
                <input 
                  type="text" 
                  [(ngModel)]="formData.prenom" 
                  name="prenom"
                  placeholder="Prénom"
                  required
                >
              </div>
            </div>

            <div class="form-group">
              <label>Email *</label>
              <input 
                type="email" 
                [(ngModel)]="formData.email" 
                name="email"
                placeholder="prenom.nom@saintjeaningenieur.org"
                required
              >
            </div>

              <div class="form-group">
                <label>Matricule</label>
                <input 
                  type="text" 
                  [(ngModel)]="formData.matricule" 
                  name="matricule"
                  placeholder="Ex: 2024001"
                >
              </div>

              <div class="form-group">
                <label>Classe</label>
                <select 
                  [(ngModel)]="formData.classeId" 
                  name="classeId"
                >
                  <option value="">Sélectionner une classe</option>
                  @for (classe of classes(); track classe.id) {
                    <option [value]="classe.id">{{ classe.nom }}</option>
                  }
                </select>
              </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">
              Annuler
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading()">
              {{ selectedStudent() ? 'Mettre à jour' : 'Créer' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content modal-small" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirmer la suppression</h3>
          <button class="close-btn" (click)="closeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>

        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer l'étudiant <strong>{{ selectedStudent()?.prenom }} {{ selectedStudent()?.nom }}</strong> ?</p>
          <p class="warning-text">Cette action est irréversible.</p>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeModal()">
            Annuler
          </button>
          <button class="btn btn-danger" (click)="deleteStudent()" [disabled]="isLoading()">
            Supprimer
          </button>
        </div>
      </div>
    </div>
  }
</div>
